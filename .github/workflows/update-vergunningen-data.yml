name: Update vergunningen data

on:
  schedule:
    # At 00:00 on day-of-month 1
    - cron: '0 0 1 * *'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check remote metadata (ETag / Last-Modified)
        id: check_remote
        env:
          INPUT_URL: https://statbel.fgov.be/sites/default/files/files/opendata/Building%20permits/TF_BUILDING_PERMITS.zip
          META_FILE: embuild-analyses/analyses/vergunningen-goedkeuringen/data/.remote_metadata.json
        run: |
          set -e
          # If there's no public URL configured, rely on local INPUT_FILE_PATH (do not skip)
          if [ -z "${INPUT_URL}" ]; then
            echo "INPUT_URL empty; proceeding (will use local file if present)."
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # If expected result files are missing, force a re-run even if remote metadata is unchanged.
          missing_required=false
          required_files=(
            "embuild-analyses/analyses/vergunningen-goedkeuringen/results/data_quarterly.json"
            "embuild-analyses/analyses/vergunningen-goedkeuringen/results/municipalities.json"
            "embuild-analyses/analyses/vergunningen-goedkeuringen/results/bouwvergunningen.csv"
            "embuild-analyses/analyses/vergunningen-goedkeuringen/results/metadata.json"
          )
          for f in "${required_files[@]}"; do
            if [ ! -f "$f" ]; then
              echo "Missing required result file: $f"
              missing_required=true
            fi
          done

          mkdir -p "$(dirname "$META_FILE")"
          headers=$(curl -sI "${INPUT_URL}" || true)
          REMOTE_ETAG=$(printf '%s\\n' "$headers" | awk -F': ' '/^ETag:/ {print $2}' | tr -d '\\r"') || true
          REMOTE_LASTMOD=$(printf '%s\\n' "$headers" | awk -F': ' '/^Last-Modified:/ {print substr($0,index($0,$2)) }' | tr -d '\\r') || true

          python - <<-PY
          	import os,json,sys
          	meta=os.environ.get('META_FILE')
          	etag=os.environ.get('REMOTE_ETAG') or ''
          	lm=os.environ.get('REMOTE_LASTMOD') or ''
          	if os.path.exists(meta):
          	  j=json.load(open(meta))
          	  if etag and j.get('etag')==etag:
          	    print('No change: ETag matches')
          	    sys.exit(2)
          	  if lm and j.get('last_modified')==lm:
          	    print('No change: Last-Modified matches')
          	    sys.exit(2)
          	print('Changed or no previous metadata, continue')
          PY
          rc=$?
          if [ "$rc" -eq 2 ] && [ "$missing_required" = "false" ]; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No remote change detected and all required results exist; skipping download and processing."
            exit 0
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Run data processor (download & process)
        if: steps.check_remote.outputs.changed == 'true'
        env:
          INPUT_URL: https://statbel.fgov.be/sites/default/files/files/opendata/Building%20permits/TF_BUILDING_PERMITS.zip
          # Optionally set INPUT_FILENAME to control the downloaded filename
          # INPUT_FILENAME: BV_opendata_latest.txt
        run: |
          set -e
          if [ -z "${INPUT_URL}" ] && { [ -z "${INPUT_FILE_PATH}" ] || [ ! -f "${INPUT_FILE_PATH}" ]; }; then
            echo "No INPUT_URL provided and no local input file found at ${INPUT_FILE_PATH}. Set a repository variable 'BV_DATA_URL' or provide INPUT_FILE_PATH." >&2
            exit 1
          fi
          python embuild-analyses/analyses/vergunningen-goedkeuringen/src/process_data.py

      - name: Update remote metadata and checksum
        if: steps.check_remote.outputs.changed == 'true'
        env:
          INPUT_URL: https://statbel.fgov.be/sites/default/files/files/opendata/Building%20permits/TF_BUILDING_PERMITS.zip
          META_FILE: embuild-analyses/analyses/vergunningen-goedkeuringen/data/.remote_metadata.json
        run: |
          set -e
          mkdir -p "$(dirname "$META_FILE")"
          headers=$(curl -sI "${INPUT_URL}" || true)
          REMOTE_ETAG=$(printf '%s\\n' "$headers" | awk -F': ' '/^ETag:/ {print $2}' | tr -d '\\r"') || true
          REMOTE_LASTMOD=$(printf '%s\\n' "$headers" | awk -F': ' '/^Last-Modified:/ {print substr($0,index($0,$2)) }' | tr -d '\\r') || true
          fname=$(basename "${INPUT_URL}")
          download_path=embuild-analyses/analyses/vergunningen-goedkeuringen/data/$fname
          if [ -f "$download_path" ]; then
            sha=$(sha256sum "$download_path" | cut -d' ' -f1)
          else
            sha=''
          fi
          python - <<-PY
          	import json, os
          	meta={'url': os.environ.get('INPUT_URL'), 'etag': os.environ.get('REMOTE_ETAG') or None, 'last_modified': os.environ.get('REMOTE_LASTMOD') or None, 'sha256': os.environ.get('sha') or None}
          	json.dump(meta, open(os.environ.get('META_FILE'), 'w'), indent=2)
          PY

      - name: Update publication date from Statbel
        if: steps.check_remote.outputs.changed == 'true'
        run: |
          python scripts/update_publication_date.py vergunningen-aanvragen "https://statbel.fgov.be/nl/themas/bouwen-wonen/bouwvergunningen"
          python scripts/update_publication_date.py vergunningen-goedkeuringen "https://statbel.fgov.be/nl/themas/bouwen-wonen/bouwvergunningen"

      - name: Commit and push changes if any
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add embuild-analyses/analyses/vergunningen-goedkeuringen/results
          git add embuild-analyses/analyses/vergunningen-goedkeuringen/data/.remote_metadata.json || true
          git add embuild-analyses/analyses/vergunningen-aanvragen/content.mdx || true
          git add embuild-analyses/analyses/vergunningen-goedkeuringen/content.mdx || true
          if ! git diff --staged --quiet; then
            git commit -m "chore(data): update vergunningen results (auto)"
            git push origin HEAD:main
          else
            echo "No changes to commit"
          fi
