name: Update gemeentelijke-investeringen data

on:
  # Manual trigger only - data files need to be manually exported from BI application
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check required input files exist
        id: check_files
        run: |
          set -e
          missing_files=false
          required_files=(
            "embuild-analyses/analyses/gemeentelijke-investeringen/data/mjp 2014 bv.csv"
            "embuild-analyses/analyses/gemeentelijke-investeringen/data/mjp 2020 bv.csv"
            "embuild-analyses/analyses/gemeentelijke-investeringen/data/mjp bv 26.csv"
            "embuild-analyses/analyses/gemeentelijke-investeringen/data/mjp rek 2014.csv"
            "embuild-analyses/analyses/gemeentelijke-investeringen/data/mjp rek 2020.csv"
            "embuild-analyses/analyses/gemeentelijke-investeringen/data/mjp rek 2026.csv"
          )
          for f in "${required_files[@]}"; do
            if [ ! -f "$f" ]; then
              echo "Missing required input file: $f"
              missing_files=true
            fi
          done
          
          if [ "$missing_files" = "true" ]; then
            echo "ERROR: Some required input files are missing. Please ensure all CSV files are committed."
            echo "files_exist=false" >> "$GITHUB_OUTPUT"
            exit 1
          else
            echo "All required input files found."
            echo "files_exist=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Process investment data (REK and BV)
        if: steps.check_files.outputs.files_exist == 'true'
        run: |
          set -e
          echo "Processing investment data..."
          python embuild-analyses/analyses/gemeentelijke-investeringen/src/process_investments.py

      - name: Prepare visualization data
        if: steps.check_files.outputs.files_exist == 'true'
        run: |
          set -e
          echo "Preparing visualization data..."
          python embuild-analyses/analyses/gemeentelijke-investeringen/src/prepare_visualizations.py

      - name: Verify output files
        if: steps.check_files.outputs.files_exist == 'true'
        run: |
          set -e
          missing_output=false
          required_output=(
            "embuild-analyses/public/data/gemeentelijke-investeringen/bv_lookups.json"
            "embuild-analyses/public/data/gemeentelijke-investeringen/bv_vlaanderen_data.json"
            "embuild-analyses/public/data/gemeentelijke-investeringen/rek_lookups.json"
            "embuild-analyses/public/data/gemeentelijke-investeringen/rek_vlaanderen_data.json"
            "embuild-analyses/public/data/gemeentelijke-investeringen/metadata.json"
          )
          for f in "${required_output[@]}"; do
            if [ ! -f "$f" ]; then
              echo "Missing expected output file: $f"
              missing_output=true
            fi
          done
          
          if [ "$missing_output" = "true" ]; then
            echo "ERROR: Some expected output files are missing."
            exit 1
          else
            echo "All expected output files generated successfully."
          fi

      - name: Commit and push changes
        if: steps.check_files.outputs.files_exist == 'true'
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage all changes in results and public data directories
          git add embuild-analyses/analyses/gemeentelijke-investeringen/results/
          git add embuild-analyses/public/data/gemeentelijke-investeringen/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore(data): update gemeentelijke-investeringen visualization data

Generated from latest BBC-DR data export
- Processed BV (beleidsdomein) data for rapportjaren: 2014, 2020, 2026
- Processed REK (economische rekening) data for rapportjaren: 2014, 2020, 2026
- Updated municipality aggregations and lookups"
            git push
          fi
